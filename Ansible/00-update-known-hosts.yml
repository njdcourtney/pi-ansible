# This playbook updates the host keys on the host running it.
# Spurious entries in known_hosts can leave you vulnerable to MITM attacks
# so this playbook should only be run if you're confident in the identity of the endpoints
# and have a valid reason for the SSH key changing eg. first boot after flashing the SD card.
#
# Modified from this gist: https://gist.github.com/EntropyWorks/a768b3bc4444146d56be81af05d73fed

- name: Update local known-hosts
  hosts: pi
  gather_facts: false
  vars:
    known_hosts_file: '~/.ssh/known_hosts'

  tasks:
    - name: Simple A record (IPV4 address) lookup for example.com
      shell: "dig +short {{ inventory_hostname }}"
      register: ipaddr
      delegate_to: localhost

    - name: For each host, scan for its ssh public key
      shell: "ssh-keyscan -t rsa {{ inventory_hostname }},{{ ipaddr['stdout'] }}"
      register: ssh_known_host_results
      delegate_to: localhost

    - name: Remove any previous entry
      known_hosts:
        name: "{{inventory_hostname }}"
        state: "absent"
        path: "{{ known_hosts_file }}"
      delegate_to: localhost

    - name: Add/update the public key in the '{{ known_hosts_file }}'
      known_hosts:
        name: "{{ inventory_hostname }}"
        key: "{{ ssh_known_host_results.stdout }}"
        state: "present"
        path: "{{ known_hosts_file }}"
      delegate_to: localhost




    
    

