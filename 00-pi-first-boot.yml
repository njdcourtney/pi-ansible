# Invocation
# ansible-playbook ./00-pi-first-boot.yml -k

# Raspberry Pi has a default username and password, add a new admin user so
# the default user can be deleted in the hardening plabook.

# This is the one and only time that we'll use the default 'pi' user

- name: Add new admin user to newly installed Pi
  hosts: pi
  # This is the well-known default username and password that 
  # we're actively changing.
  remote_user: pi
  become: yes
  gather_facts: false

  tasks:
    - name: Create admin user
      user:
        name: "{{ admin_user }}"
        generate_ssh_key: yes
        password: "{{ admin_password }}"
        shell: /bin/bash

    - name: Add management station ssh key to admin user authorized keys
      authorized_key:
        user: "{{ admin_user }}"
        state: present
        key: "{{ admin_ssh_key }}"

    - name: Add extra groups to admin user
      user:
        name: "{{ admin_user }}"
        groups: "{{ admin_groups }}"
        append: yes

    - name: Add sudoers entry to allow admin user passwordless sudo
      copy:
        content: "{{ admin_user }} ALL=(ALL) NOPASSWD: ALL"
        dest: "/etc/sudoers.d/020_{{ admin_user }}-nopasswd"
        mode: 0440

- name: Remove default admin user
  hosts: pi
  remote_user: "{{ admin_user }}"
  become: yes
  gather_facts: false

  tasks:
    - name: Kill and pi processes
      become: yes
      shell: pkill -u pi

    - name: Remove the default 'pi' user
      become: yes
      user:
        name: pi
        state: absent
        remove: yes

    # Reboot to flush everything
    - name: Reboot the pi
      shell: sleep 2 && shutdown -r now 'Reboot required'
      async: 1
      poll: 0
